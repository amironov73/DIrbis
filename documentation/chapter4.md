### Прочие (вспомогательные) классы и функции

#### FoundLine

Строка найденной записи, может содержать результат расформатирования найденной записи.

#### MenuFile

Файл меню. Состоит из пар строк (`MenuLine`).

#### IniFile, IniSection и IniLine

INI-файл, состоящий из секций (`IniSection`), которые в свою очередь состоят из строк вида "ключ=значение" (`IniLine`).

#### TreeFile и TreeLine

TRE-файл -- древовидный справочник.

#### DatabaseInfo

Информация о базе данных ИРБИС.

#### ProcessInfo

Информация о запущенном на ИРБИС-сервере процессе.

#### VersionInfo

Информация о версии ИРБИС-сервера.

#### ClientInfo

Информация о клиенте, подключенном к серверу ИРБИС (не обязательно о текущем).

| Поле                 | Назначение
|----------------------|-----------
| string number        | Номер по порядку в списке.
| string ipAddress     | IP-адрес клиента.
| string port          | Номер порта.
| string name          | Логин пользователя.
| string id            | Идентификатор клиента (просто уникальное число).
| string workstation   | Тип рабочей станции.
| string registered    | Момент регистрации клиента на сервере.
| string acknowledged  | Последний момент подтверждения.
| string lastCommand   | Последняя выполненная или выполняемая команда.
| string commandNumber | Номер последней команды.

#### UserInfo

Информация о зарегистрированном пользователе системы (по данным `client_m.mnu`). Состоит из полей:

| Поле          | Назначение
|---------------|-----------
| number        | Номер по порядку в списке.
| name          | Логин пользователя.
| password      | Пароль.
| cataloger     | Доступность АРМ "Каталогизатор".
| reader        | Доступность АРМ "Читатель".
| circulation   | Доступность АРМ "Книговыдача".
| acquisitions  | Доступность АРМ "Комплектатор".
| provision     | Доступность АРМ "Книгообеспеченность".
| administrator | Доступность АРМ "Администратор".

Если строка доступа к АРМ пустая, то доступ к соответствующему АРМ запрещен.

```d
auto users = client.getUserList;
auto newUser = new UserInfo;
newUser.name = "Tyler Durden";
newUser.password = "FightClub";
newUser.cataloger = "INI\\TylerC.ini";
users ~= newUser;
client.updateUserList(users);
```

#### TableDefinition

Данные для метода printTable.

#### ServerStat

Статистика работы ИРБИС-сервера.

#### PostingParameters

Параметры для запроса постингов с сервера.

#### TermParameters

Параметры для запроса терминов с сервера.

#### TermInfo

Информация о термине поискового словаря.

#### TermPosting

Постинг термина в поисковом индексе.

#### SearchParameters

Параметры для поиска записей (метод SearchEx).

#### SearchScenario

Сценарий поиска.

#### ParFile

PAR-файл -- содержит пути к файлам базы данных ИРБИС.

#### OptFile и OptLine

OPT-файл -- файл оптимизации рабочих листов и форматов показа.

#### GblStatement и GblSettings

Поддержка глобальной корректировки базы данных.

#### ClientQuery

Клиентский запрос. Служебная структура (создается на стеке).

**this(Connection connection, string command)** -- конструктор, принимающий подключение к серверу (из него берутся идентификатор клиента и другие служебные поля) и одно- или двухбуквенную команду (например "A" или "+1").

**ref ClientQuery add(int value)** -- добавление в запрос целого числа в десятеричной системе.

**ref ClientQuery add(bool value)** -- добавление в запрос логического значения. Фактически кодируется как `0` или `1`.

**ref ClientQuery addAnsi(string text)** -- добавление в запрос строки в кодировке ANSI.

**bool addFormat(string text)** -- добавление в запрос спецификации формата. Если спецификация не приводит к форматированию (например, формат -- пустая строка), возвращается `false`. При необходимости автоматически выбирается кодировка UTF-8.

**ref ClientQuery addUtf(string text)** -- добавление в запрос строки в кодировке UTF-8.

**ubyte[] encode() const** -- получение байтового представления запроса.

**ref ClientQuery newLine()** -- добавление в запрос перевода строки.

Почти все методы возвращают адрес структуры, поэтому можно строить "цепочечные" вызовы. Пример применения ClientQuery: разблокировка записи по её MFN.

```d
// Создаем клиентский запрос с командой "F"
scope auto query = ClientQuery (connection, "F");

// Добавляем в запрос две строки:
// имя базы данных в кодировке ANSI
// и MFN записи (десятеричное число) 
query.addAnsi(databaseName).newLine
    .add(mfn).newLine;

// Отправляем запрос на сервер и получаем ответ
scope auto response = connection.execute(query);

// Проверяем, успешно ли выполнен запрос
auto ok = response.ok && response.checkReturnCode;

// Если возникла ошибка, бросаем исключение
if (!ok)
    connection.throwOnError;
```

#### ServerResponse

Ответ сервера. Служебная структура (создается на стеке).

**this(ubyte[] buffer)** -- конструктор, принимающий слайс байтов, полученных сокетом от сервера.

**bool ok() const nothrow** -- успешно ли получен ответ? Если при получении ответа произошел сетевой сбой, будет выдано `false`.

**bool eof() const nothrow** -- все строки ответа прочитаны, больше данных нет.

**bool checkReturnCode(int[] allowed ...)** -- проверка, не выставили ли сервер признак ошибки в коде возврата. Можно указать коды возврата, которые не будут интерпретироваться как ошибочные, например:

```d
if (!response.checkReturnCode(-201, -202, -203)) {
    // бросаем исключение
    connection.throwOnError;
}
```

**ubyte[] getLine()** -- считывание строки ответа в "сыром виде" (без перевода в правильную кодировку). Если уже достигнут конец данных (см. метод `eof`), возвращается `null`.

**int getReturnCode()** -- считывание кода возврата. Нулевой или положительные код возврата означает успешное выполнение, отрицательный -- ошибку. ВНИМАНИЕ: код возврата выставляется не для всех команд!

**string readAnsi()** -- считывание строки в кодировке ANSI. Если уже достигнут конец данных, возвращается `null`.

**int readInteger()** -- считывание строки, представляющей собой целое десятеричное число (возможно, со знаком). Если уже достигнут конец данных, или строка пустая, возвращается 0. Если строка не является целым числом, бросается исключение.

**string[] readRemainingAnsiLines()** -- считывание остатка ответа как слайса строк в кодировке ANSI. Если уже достигнут конец, будет выдан пустой слайс.

**string readRemainingAnsiText()** -- считывание остатка ответа в виде одной строки в кодировке ANSI (внутри строки могут быть символы перевода строки). Если уже достигнут конец данных, возвращается `null`.

**string[] readRemainingUtfLines()** -- считывание остатка ответа как слайса строк в кодировке ANSI. Если уже достигнут конец, будет выдан пустой слайс.

**string readRemainingUtfText()** -- считывание остатка ответа в виде одной строки в кодировке UTF-8 (внутри строки могут быть символы перевода строки). Если уже достигнут конец данных, возвращается `null`.

**string readUtf()** -- считывание строки в кодировке UTF-8. Если уже достигнут конец данных, возвращается `null`.

[Предыдущая глава](chapter3.md)



